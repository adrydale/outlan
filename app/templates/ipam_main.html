{% extends "base.html" %}
{% block content %}
{% if success_message %}
<div class="success-message">
    {{ success_message }}
</div>
{% endif %}

<div id="error-message" class="error-message" style="display: none;"></div>

{% for block in blocks %}
<div class="block-section" data-block-id="{{ block['id'] }}" data-collapsed="{{ block['collapsed'] or 0 }}" data-position="{{ block['position'] or 0 }}" draggable="false">
    <div class="block-header">
        <div class="block-title-section">
            <button type="button" class="btn-small collapse-btn" data-block-id="{{ block['id'] }}" title="Collapse/Expand Block">
                <span class="collapse-icon">{% if block['collapsed'] %}+{% else %}−{% endif %}</span>
            </button>
            <h3 class="block-title" data-block-id="{{ block['id'] }}">{{ block['name'] }}</h3>
            <input type="text" class="block-name-edit" data-block-id="{{ block['id'] }}" value="{{ block['name'] }}" style="display: none;" minlength="1" maxlength="50"/>
        </div>
        <div class="block-actions">
            <button type="button" class="btn-small rename-btn" data-block-id="{{ block['id'] }}" title="Rename Block">Rename</button>
            <button type="button" class="btn-small save-btn" data-block-id="{{ block['id'] }}" style="display: none;" title="Save Changes">Save</button>
            <button type="button" class="btn-small cancel-btn" data-block-id="{{ block['id'] }}" style="display: none;" title="Cancel Changes">Cancel</button>
            <form method="GET" action="{{ url_for('ipam.export_csv', block_id=block['id']) }}" style="display:inline;">
                <button type="submit" class="btn-small">Export CSV</button>
            </form>
            <button type="button" class="btn-small delete-btn" data-delete-type="block" data-block-id="{{ block['id'] }}" data-delete-name="{{ block['name']|e }}">Delete Block</button>
            <button type="button" class="btn-small move-up-btn" data-block-id="{{ block['id'] }}" title="Move Block Up">↑</button>
            <button type="button" class="btn-small move-down-btn" data-block-id="{{ block['id'] }}" title="Move Block Down">↓</button>
        </div>
    </div>
    <div class="block-content" data-block-id="{{ block['id'] }}" {% if block['collapsed'] %}style="display: none;"{% endif %}>
    <table class="subnet-table">
        <tr>
            <th>Network</th>
            <th>VLAN</th>
            <th>Name</th>
            <th>Actions</th>
        </tr>
        {% if block['id'] in subnets_by_block %}
            {% for s in subnets_by_block[block['id']] %}
            <tr>
            {% if edit_id and s['id'] == edit_id|int %}
                <form method="POST" action="{{ url_for('ipam.edit_subnet', subnet_id=s['id']) }}" class="subnet-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <td><input type="text" name="cidr" value="{{ s['cidr'] }}" class="subnet-input" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$" title="Enter valid CIDR format (e.g., 192.168.1.0/24)" required/></td>
                    <td><input type="number" name="vlan_id" value="{{ s['vlan_id'] }}" class="subnet-input" min="1" max="4094" title="VLAN ID must be between 1 and 4094 (optional)" /></td>
                    <td><input type="text" name="name" value="{{ s['name'] }}" class="subnet-input" required minlength="1" maxlength="50"/></td>
                    <td>
                        <input type="hidden" name="block_id" value="{{ s['block_id'] }}">
                        <button type="submit" class="btn-small">Save</button>
                        <a href="{{ url_for('main.index') }}" class="btn-small">Cancel</a>
                    </td>
                </form>
            {% else %}
                <td>{{ s['cidr'] }}</td>
                <td>{{ s['vlan_id'] }}</td>
                <td>{{ s['name'] }}</td>
                <td>
                    <a href="{{ url_for('main.index', edit=s['id']) }}" class="btn-small edit-link">Edit</a>
                    <button type="button" class="btn-small delete-btn" data-delete-type="subnet" data-delete-id="{{ s['id'] }}" data-delete-name="{{ s['name']|e }}" data-delete-cidr="{{ s['cidr']|e }}" data-delete-vlan="{{ s['vlan_id'] }}" data-delete-block="{{ s['block_name']|e }}">Delete</button>
                </td>
            {% endif %}
            </tr>
            {% endfor %}
        {% endif %}
        <tr>
            <form method="POST" action="{{ url_for('ipam.add_subnet') }}" class="subnet-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <td><input type="text" name="cidr" placeholder="Network" class="subnet-input" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$" title="Enter valid CIDR format (e.g., 192.168.1.0/24)" required/></td>
                <td><input type="number" name="vlan_id" placeholder="VLAN" class="subnet-input" min="1" max="4094" title="VLAN ID must be between 1 and 4094 (optional)" /></td>
                <td><input type="text" name="name" placeholder="Name" class="subnet-input" required minlength="1" maxlength="50"/></td>
                <td>
                    <input type="hidden" name="block_id" value="{{ block['id'] }}">
                    <button type="submit" class="btn-small">Add</button>
                </td>
            </form>
        </tr>
    </table>
    </div>
</div>
{% endfor %}
<div class="block-section">
    <form method="POST" action="{{ url_for('ipam.add_block_route') }}" class="add-block-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="text" name="block_name" placeholder="New Block Name" class="block-name-input" required minlength="1" maxlength="50"/>
        <button type="submit" class="btn-main">Add Block</button>
    </form>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div id="modalContent" class="modal-content">
        <h3 id="modalTitle">Delete Confirmation</h3>
        <div id="modalMessage">
            <p>Are you sure you want to delete this item?</p>
        </div>
        <div id="modalDetails" style="display: none;">
            <table class="modal-details-table">
                <thead>
                    <tr>
                        <th>Network</th>
                        <th>VLAN</th>
                        <th>Name</th>
                    </tr>
                </thead>
                <tbody id="modalDetailsBody">
                </tbody>
            </table>
        </div>
        <div class="modal-buttons">
            <button id="modalCancelBtn" class="btn-small">Cancel</button>
            <button id="modalConfirmBtn" class="btn-small delete-btn">Delete</button>
        </div>
    </div>
</div>

<script>
// Real-time validation for CIDR format
document.querySelectorAll('input[name="cidr"]').forEach(function(input) {
    // Prevent invalid characters (only allow numbers, periods, and forward slash)
    input.addEventListener('keypress', function(e) {
        const char = String.fromCharCode(e.which);
        if (!/[\d\.\/]/.test(char) && e.which !== 8 && e.which !== 9 && e.which !== 37 && e.which !== 39) {
            e.preventDefault();
        }
    });
    
    // Handle paste events to filter invalid content
    input.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const validChars = pastedText.replace(/[^\d\.\/]/g, '');
        if (validChars) {
            this.value = validChars;
        }
    });
    
    // Real-time validation and cleaning
    input.addEventListener('input', function() {
        // Remove any invalid characters (keep only numbers, periods, and forward slash)
        this.value = this.value.replace(/[^\d\.\/]/g, '');
        
        const cidrPattern = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}\/[0-9]{1,2}$/;
        if (this.value && !cidrPattern.test(this.value)) {
            this.setCustomValidity('Please enter a valid CIDR format (e.g., 192.168.1.0/24)');
            this.style.borderColor = '#ef4444';
        } else {
            this.setCustomValidity('');
            this.style.borderColor = '';
        }
    });
    
    // Clear validation on blur if empty
    input.addEventListener('blur', function() {
        if (!this.value) {
            this.setCustomValidity('');
            this.style.borderColor = '';
        }
    });
});

// Real-time validation for VLAN ID
document.querySelectorAll('input[name="vlan_id"]').forEach(function(input) {
    // Prevent non-numeric input
    input.addEventListener('keypress', function(e) {
        const char = String.fromCharCode(e.which);
        if (!/[\d]/.test(char) && e.which !== 8 && e.which !== 9 && e.which !== 37 && e.which !== 39) {
            e.preventDefault();
        }
    });
    
    // Handle paste events to filter non-numeric content
    input.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const numericOnly = pastedText.replace(/[^\d]/g, '');
        if (numericOnly) {
            this.value = numericOnly;
        }
    });
    
    // Real-time validation
    input.addEventListener('input', function() {
        // Remove any non-numeric characters
        this.value = this.value.replace(/[^\d]/g, '');
        
        const vlan = parseInt(this.value);
        if (this.value && (vlan < 1 || vlan > 4094)) {
            this.setCustomValidity('VLAN ID must be between 1 and 4094');
            this.style.borderColor = '#ef4444';
        } else {
            this.setCustomValidity('');
            this.style.borderColor = '';
        }
    });
    
    // Clear validation on blur if empty
    input.addEventListener('blur', function() {
        if (!this.value) {
            this.setCustomValidity('');
            this.style.borderColor = '';
        }
    });
});

// Form submission with success feedback
document.querySelectorAll('.subnet-form').forEach(function(form) {
    form.addEventListener('submit', function(e) {
        if (!this.checkValidity()) {
            e.preventDefault();
            return false;
        }
    });
});

// Focus the first CIDR input field on page load
document.addEventListener('DOMContentLoaded', function() {
    const firstCidrInput = document.querySelector('input[name="cidr"]');
    if (firstCidrInput) {
        firstCidrInput.focus();
    }
    
    // Initialize block collapse states
    initializeBlockCollapse();
    
    // Initialize inline editing
    initializeInlineEditing();
    
    // Initialize block reordering
    initializeBlockReordering();
});

// Block collapse functionality
function initializeBlockCollapse() {
    // Set initial collapse states
    document.querySelectorAll('.block-section').forEach(function(blockSection) {
        const blockId = blockSection.dataset.blockId;
        const collapsed = blockSection.dataset.collapsed === '1';
        const content = blockSection.querySelector('.block-content');
        const collapseIcon = blockSection.querySelector('.collapse-icon');
        
        if (collapsed) {
            content.style.display = 'none';
            collapseIcon.textContent = '+';
        }
    });
    
    // Add collapse button event listeners
    document.querySelectorAll('.collapse-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const blockId = this.dataset.blockId;
            const blockSection = document.querySelector(`[data-block-id="${blockId}"]`);
            const content = blockSection.querySelector('.block-content');
            const collapseIcon = this.querySelector('.collapse-icon');
            const isCollapsed = content.style.display === 'none';
            
            // Toggle display
            content.style.display = isCollapsed ? 'block' : 'none';
            collapseIcon.textContent = isCollapsed ? '−' : '+';
            
            // Update database
            fetch(`/api/toggle_collapse/${blockId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            }).catch(error => {
                console.error('Error toggling collapse:', error);
            });
        });
    });
}

// Inline editing functionality
function initializeInlineEditing() {
    // Add rename button event listeners
    document.querySelectorAll('.rename-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const blockId = this.dataset.blockId;
            const blockSection = document.querySelector(`[data-block-id="${blockId}"]`);
            const title = blockSection.querySelector('.block-title');
            const editInput = blockSection.querySelector('.block-name-edit');
            const saveBtn = blockSection.querySelector('.save-btn');
            const cancelBtn = blockSection.querySelector('.cancel-btn');
            const renameBtn = this;
            
            // Show edit mode
            title.style.display = 'none';
            editInput.style.display = 'inline-block';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            renameBtn.style.display = 'none';
            
            // Focus on input
            editInput.focus();
            editInput.select();
        });
    });
    
    // Add save button event listeners
    document.querySelectorAll('.save-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const blockId = this.dataset.blockId;
            const blockSection = document.querySelector(`[data-block-id="${blockId}"]`);
            const title = blockSection.querySelector('.block-title');
            const editInput = blockSection.querySelector('.block-name-edit');
            const saveBtn = this;
            const cancelBtn = blockSection.querySelector('.cancel-btn');
            const renameBtn = blockSection.querySelector('.rename-btn');
            
            const newName = editInput.value.trim();
            if (newName.length === 0) {
                alert('Block name cannot be empty');
                return;
            }
            
            // Update via AJAX
            fetch(`/rename_block/${blockId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `new_block_name=${encodeURIComponent(newName)}&csrf_token=${getCsrfToken()}`
            }).then(response => {
                if (response.ok) {
                    // Update title and exit edit mode
                    title.textContent = newName;
                    exitEditMode(blockSection);
                } else {
                    alert('Error saving block name');
                }
            }).catch(error => {
                console.error('Error saving:', error);
                alert('Error saving block name');
            });
        });
    });
    
    // Add cancel button event listeners
    document.querySelectorAll('.cancel-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const blockId = this.dataset.blockId;
            const blockSection = document.querySelector(`[data-block-id="${blockId}"]`);
            const editInput = blockSection.querySelector('.block-name-edit');
            
            // Restore original value
            const title = blockSection.querySelector('.block-title');
            editInput.value = title.textContent;
            
            exitEditMode(blockSection);
        });
    });
    
    // Add enter key support for edit input
    document.querySelectorAll('.block-name-edit').forEach(function(input) {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const blockId = this.dataset.blockId;
                const blockSection = document.querySelector(`[data-block-id="${blockId}"]`);
                const saveBtn = blockSection.querySelector('.save-btn');
                saveBtn.click();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                const blockId = this.dataset.blockId;
                const blockSection = document.querySelector(`[data-block-id="${blockId}"]`);
                const cancelBtn = blockSection.querySelector('.cancel-btn');
                cancelBtn.click();
            }
        });
    });
}

function exitEditMode(blockSection) {
    const title = blockSection.querySelector('.block-title');
    const editInput = blockSection.querySelector('.block-name-edit');
    const saveBtn = blockSection.querySelector('.save-btn');
    const cancelBtn = blockSection.querySelector('.cancel-btn');
    const renameBtn = blockSection.querySelector('.rename-btn');
    
    // Hide edit mode
    title.style.display = 'inline-block';
    editInput.style.display = 'none';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
    renameBtn.style.display = 'inline-block';
}

function getCsrfToken() {
    return document.querySelector('input[name="csrf_token"]').value;
}

// Block reordering functionality with up/down arrows
function initializeBlockReordering() {
    // Add up/down button event listeners
    addReorderEventListeners();
    
    // Initialize button states
    updateButtonStates();
}



function addReorderEventListeners() {
    document.querySelectorAll('.move-up-btn').forEach(function(btn) {
        btn.addEventListener('click', handleMoveUp);
    });
    
    document.querySelectorAll('.move-down-btn').forEach(function(btn) {
        btn.addEventListener('click', handleMoveDown);
    });
}

function removeReorderEventListeners() {
    document.querySelectorAll('.move-up-btn').forEach(function(btn) {
        btn.removeEventListener('click', handleMoveUp);
    });
    
    document.querySelectorAll('.move-down-btn').forEach(function(btn) {
        btn.removeEventListener('click', handleMoveDown);
    });
}

function handleMoveUp(e) {
    const blockSection = e.target.closest('.block-section');
    const blockSections = Array.from(document.querySelectorAll('.block-section[data-block-id]'));
    const currentIndex = blockSections.indexOf(blockSection);
    
    if (currentIndex > 0) {
        const prevBlock = blockSections[currentIndex - 1];
        blockSection.parentNode.insertBefore(blockSection, prevBlock);
        updatePositions();
        updateButtonStates();
        saveNewOrder();
    }
}

function handleMoveDown(e) {
    const blockSection = e.target.closest('.block-section');
    const blockSections = Array.from(document.querySelectorAll('.block-section[data-block-id]'));
    const currentIndex = blockSections.indexOf(blockSection);
    
    if (currentIndex < blockSections.length - 1) {
        const nextBlock = blockSections[currentIndex + 1];
        blockSection.parentNode.insertBefore(blockSection, nextBlock.nextSibling);
        updatePositions();
        updateButtonStates();
        saveNewOrder();
    }
}

function updateButtonStates() {
    const blockSections = Array.from(document.querySelectorAll('.block-section[data-block-id]'));
    
    blockSections.forEach((blockSection, index) => {
        const upBtn = blockSection.querySelector('.move-up-btn');
        const downBtn = blockSection.querySelector('.move-down-btn');
        
        if (upBtn) {
            upBtn.disabled = index === 0;
            upBtn.style.opacity = index === 0 ? '0.5' : '1';
        }
        
        if (downBtn) {
            downBtn.disabled = index === blockSections.length - 1;
            downBtn.style.opacity = index === blockSections.length - 1 ? '0.5' : '1';
        }
    });
}

function updatePositions() {
    const blocks = document.querySelectorAll('.block-section');
    blocks.forEach((block, index) => {
        block.dataset.position = index + 1;
    });
}

function saveNewOrder() {
    const blocks = document.querySelectorAll('.block-section[data-block-id]');
    const blockData = Array.from(blocks).map((block, index) => ({
        id: parseInt(block.dataset.blockId),
        position: index + 1
    }));
    
    fetch('/api/update_block_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ blocks: blockData })
    }).then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        }
    }).then(data => {
        // Success - no need to reload, just update button states
        updateButtonStates();
    }).catch(error => {
        console.error('Error saving order:', error);
        showError('Failed to save block order: ' + error.message);
    });
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    } else {
        alert(message);
    }
}

// Delete confirmation modal functionality
function showDeleteModal(type, id, name, details) {
    const modal = document.getElementById('deleteModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalDetails = document.getElementById('modalDetails');
    const modalDetailsBody = document.getElementById('modalDetailsBody');
    const confirmBtn = document.getElementById('modalConfirmBtn');
    
    if (type === 'block') {
        modalTitle.textContent = 'Delete Block';
        modalMessage.innerHTML = '<p>Are you sure you want to delete the block <strong>"' + name + '"</strong>?</p><p>This will also delete all subnets within this block.</p>';
        modalDetails.style.display = 'none';
        confirmBtn.onclick = function() { deleteBlock(id); };
    } else if (type === 'subnet') {
        modalTitle.textContent = 'Delete Subnet';
        modalMessage.innerHTML = '<p>Are you sure you want to delete this subnet?</p><p>This subnet is part of block <strong>"' + details.block + '"</strong>.</p>';
        modalDetails.style.display = 'block';
        modalDetailsBody.innerHTML = `
            <tr>
                <td>${details.cidr}</td>
                <td>${details.vlan}</td>
                <td>${details.name}</td>
            </tr>
        `;
        confirmBtn.onclick = function() { deleteSubnet(id); };
    }
    
    modal.style.display = 'flex';
    
    // Focus the confirm button for keyboard navigation
    confirmBtn.focus();
}

function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

function deleteBlock(blockId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/delete_block/' + blockId;
    
    // Add CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

function deleteSubnet(subnetId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/delete_subnet/' + subnetId;
    
    // Add CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Close modal when clicking outside or on cancel
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('deleteModal');
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            hideDeleteModal();
        }
    });
    
    document.getElementById('modalCancelBtn').addEventListener('click', hideDeleteModal);
    
    // Add keyboard support
    document.addEventListener('keydown', function(e) {
        if (modal.style.display === 'flex') {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('modalConfirmBtn').click();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideDeleteModal();
            }
        }
    });
    
    // Add event listeners for delete buttons
    document.querySelectorAll('.delete-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const deleteType = this.getAttribute('data-delete-type');
            const deleteName = this.getAttribute('data-delete-name');
            
            if (deleteType === 'block') {
                const blockId = this.getAttribute('data-block-id');
                showDeleteModal('block', blockId, deleteName);
            } else if (deleteType === 'subnet') {
                const subnetId = this.getAttribute('data-delete-id');
                const cidr = this.getAttribute('data-delete-cidr');
                const vlan = this.getAttribute('data-delete-vlan');
                const block = this.getAttribute('data-delete-block');
                const details = {
                    cidr: cidr,
                    vlan: vlan,
                    name: deleteName,
                    block: block
                };
                showDeleteModal('subnet', subnetId, deleteName, details);
            }
        });
    });
});
</script>
{% endblock %}